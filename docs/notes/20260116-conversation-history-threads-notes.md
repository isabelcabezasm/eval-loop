# Implementation Notes: Conversation History with Threads

**Plan:**
[20260116-conversation-history-threads.md](../plans/20260116-conversation-history-threads.md)

**Completed:** 2026-01-19

---

## Final Implementation (Per-User Session-Based Threads)

### Summary

The original plan used explicit `thread_id` parameters passed between client and
server. This was replaced with a simpler **session-based** approach where:

1. Frontend generates a `session_id` (UUID v4) when user clicks "Start Chat"
2. Backend maintains a `dict[UserSessionId, AgentThread]` mapping
3. Same session ID always gets the same thread (conversation continuity)
4. Different session IDs get separate threads (user isolation)

### QAEngine Implementation

```python
class QAEngine:
    def __init__(self, agent: ChatAgent, axiom_store: AxiomStore):
        self._threads: dict[UserSessionId, AgentThread] = {}

    def get_thread(self, session_id: UserSessionId) -> AgentThread:
        if session_id not in self._threads:
            self._threads[session_id] = self.agent.get_new_thread()
        return self._threads[session_id]

    async def invoke_streaming(self, question: str, session_id: UserSessionId, ...):
        thread = self.get_thread(session_id)
        async for chunk in self.agent.run_stream(prompt, thread=thread, store=True):
            ...

    async def reset_thread(self, session_id: UserSessionId) -> None:
        self._threads[session_id] = self.agent.get_new_thread()
```

### API Implementation

**GenerateRequest:**
```python
class GenerateRequest(BaseModel):
    question: str
    reality: Reality | None
    session_id: str  # Required - frontend generates UUID
```

**RestartRequest:**
```python
class RestartRequest(BaseModel):
    session_id: str
```

### Frontend Implementation

```typescript
// src/ui/utils/session.ts
export function generateSessionId(): string {
  return crypto.randomUUID();
}

// src/ui/App.tsx
const [sessionId, setSessionId] = useState<string | null>(null);

const handleStartChat = () => {
  setSessionId(generateSessionId());  // Generate on start
  setIsContextLocked(true);
};

const handleClearAndRestart = async () => {
  if (sessionId) {
    await apiClient.restart(sessionId);  // Reset server-side thread
  }
  setSessionId(null);  // Clear client-side session
};
```

### Key Differences from Original Plan

| Original Plan | Current Implementation |
|---------------|------------------------|
| `thread_id` returned by server | `session_id` generated by client |
| Thread ID in API response stream | No thread ID in responses |
| `InvokeStreamingResult` dataclass | Direct `AsyncIterator` return |
| Single shared thread | Per-session thread dictionary |
| Complex lazy getter for thread ID | Simple dict lookup by session |

---

## Phase 1: Backend - Session-Based Thread Management ✅

**Completed:** January 19, 2026

### Changes Made

1. **`src/core/qa_engine.py`**
   - Added `UserSessionId = NewType("UserSessionId", str)` for type-safe session identification
   - Replaced single `self.thread` with `self._threads: dict[UserSessionId, AgentThread]`
   - Added `get_thread(session_id)` method that returns existing or creates new thread
   - Updated `invoke()`, `invoke_streaming()`, and `reset_thread()` to require `session_id` parameter

2. **`src/api/generate.py`**
   - Added `session_id: str` field to `GenerateRequest` model
   - Created new `RestartRequest` model with `session_id: str`
   - Updated `/generate` endpoint to pass `UserSessionId(request.session_id)` to QAEngine
   - Updated `/restart` endpoint to accept `RestartRequest` with session_id

3. **Test Updates**
   - `tests/core/test_qa_engine.py` - 44 tests updated with session-based thread tests
   - `tests/api/test_generate.py` - Deserialization tests include session_id
   - `tests/api/test_generate_endpoint.py` - Endpoint tests include session_id

---

## Phase 2: Frontend - Session ID Generation and Management ✅

**Completed:** January 19, 2026

### Changes Made

1. **`src/ui/utils/session.ts`** (new file)
   - Created `generateSessionId()` function using `crypto.randomUUID()` to generate UUID v4 session IDs

2. **`src/ui/utils/api.ts`**
   - Added `session_id` to `AnswerRequest` interface
   - Created `RestartRequest` interface with `session_id`
   - Updated `answer()` method to accept `sessionId` parameter and include in request body
   - Updated `restart()` method to accept `sessionId` parameter and send in request body with Content-Type header

3. **`src/ui/App.tsx`**
   - Added `sessionId` state variable (initially `null`)
   - Generate new session ID via `generateSessionId()` when "Start Chat" is clicked
   - Pass `sessionId` to `apiClient.answer()` calls
   - Pass `sessionId` to `apiClient.restart()` calls
   - Reset `sessionId` to `null` on "Clear & Restart"

4. **Test Updates**
   - `tests/ui/api.spec.ts` - Updated all `answer()` calls to include session ID, added restart tests
   - `tests/ui/session.spec.ts` (new file) - Tests for `generateSessionId()` function

---

## Phase 3: Integration Testing ✅

**Completed:** January 19, 2026

### Changes Made

1. **`tests/api/test_generate_endpoint.py`**
   - Added `test_session_isolation_between_users()` - Tests that two different session IDs maintain separate threads, and restarting one session doesn't affect the other
   - Added `test_same_session_maintains_thread()` - Tests that the same session ID maintains conversation continuity across multiple requests

### Test Results

- **103 Python tests passing** (including session isolation tests)
- **22 frontend tests passing** (including session utility tests)
- TypeScript compiles without errors
- ESLint passes

---

## Phase 4: Documentation and Examples ✅

**Completed:** January 19, 2026

### Changes Made

1. **Sample Scripts Updated**
   - `samples/basic_qa.py` - Added session_id generation and usage
   - `samples/basic_qa_streaming.py` - Added session_id for thread isolation
   - `samples/conversation_qa.py` (new) - Multi-turn conversation example showing:
     - Context retention across questions
     - Session isolation between different sessions
     - Thread reset functionality

2. **README.md Updated**
   - Added "Conversation History" section explaining the feature
   - Documented session isolation mechanism
   - Documented API endpoints (`POST /api/generate`, `POST /api/restart`)
   - Added Python usage examples

---

## Historical Notes: Original Thread-Based Approach

The sections below document the original implementation approach that was
later replaced with the session-based design above.

### Phase 1: QAEngine Thread Support (Original)

**Date:** 2026-01-19

### Summary

Implemented thread support in QAEngine to enable multi-turn conversations using
the Agent Framework's built-in thread management.

### Changes Made

1. **Task 1.1: Add Optional thread_id Parameter to invoke()**
   - Updated `invoke()` method signature to accept `thread_id: str | None =
     None`
   - Changed return type to `tuple[str, str]` returning `(response, thread_id)`
   - Passes thread_id through to `invoke_streaming()`

2. **Task 1.2: Add Optional thread_id Parameter to invoke_streaming()**
   - Updated `invoke_streaming()` method signature to accept `thread_id: str |
     None = None`
   - Created new `InvokeStreamingResult` dataclass to hold both the async
     iterator and thread_id
   - Method now returns `InvokeStreamingResult` containing chunks iterator and
     thread_id

3. **Task 1.3: Update Agent Framework Calls**
   - Updated `agent.run_stream()` call to pass `thread_id` parameter
   - Agent framework returns thread_id in the stream response, which is
     captured and returned to caller

### Design Decisions

- Used a `InvokeStreamingResult` dataclass to return both the async iterator
  and thread_id from streaming
- Thread ID is extracted from the first chunk's metadata from the agent
  framework
- Backward compatible: when `thread_id=None`, agent framework creates a new
  thread

### Files Modified

- `src/core/qa_engine.py` - Added thread support to invoke methods

---

## Phase 2: API Integration (Original)

**Date:** 2026-01-19

### Summary

Added thread_id support to the `/api/generate` endpoint, enabling clients to
maintain conversation continuity across multiple requests.

### Changes Made

1. **Task 2.1: Update Generate Endpoint for Thread Support**
   - Added optional `thread_id` field to `GenerateRequest` model
   - Created `ThreadIdResponse` model for streaming the thread_id
   - Updated `generate()` endpoint to:
     - Accept `thread_id` from request
     - Pass `thread_id` to `QAEngine.invoke_streaming()`
     - Emit `thread_id` as first response in the stream
   - Updated integration tests to validate thread_id in responses

### API Changes

**Request:**
```json
{
  "question": "How does inflation affect rates?",
  "reality": [...],
  "thread_id": "optional-existing-thread-id"
}
```

**Response (ndjson stream):**
```
{"type": "thread_id", "thread_id": "uuid-of-thread"}
{"type": "text", "text": "Based on..."}
{"type": "axiom_citation", "id": "A-001", ...}
```

### Files Modified

- `src/api/generate.py` - Added thread_id to request/response
- `tests/api/test_generate_endpoint.py` - Updated to validate thread_id

---

## Phase 4: UI Integration (Original)

**Date:** 2026-01-19

### Summary

Implemented thread_id support in the frontend to enable multi-turn
conversations through the UI. The frontend now captures the thread_id from the
first API response chunk and sends it with subsequent requests.

### Changes Made

1. **Task 4.1: Update Frontend API Client**
   - Added `ApiThreadIdChunk` Zod schema to parse thread_id responses
   - Updated `ApiChunk` discriminated union to include thread_id type
   - Exported `ThreadIdChunk` type for use in components
   - Simplified `AnswerRequest` to use `{question, reality, thread_id}`
   - Updated `answer()` method signature to `(question, realityFile?,
     threadId?)`

2. **Task 4.2: Store and Send thread_id in UI**
   - Added `threadId` state to `App.tsx`
   - Updated `streamAnswer()` function to:
     - Capture `thread_id` from response stream (first chunk)
     - Store it in component state
     - Send it with subsequent requests
   - Updated `handleClearAndRestart()` to reset `threadId` state

3. **Task 4.3: Frontend Tests**
   - Updated API client tests to use new signature
   - Added `ThreadIdChunk` to test type definitions
   - Updated test assertions to match simplified request format

### API Client Changes

**Before:**
```typescript
answer(question: string, context: string, history: Message[]): AsyncGenerator<...>
```

**After:**
```typescript
answer(question: string, realityFile?: File, threadId?: string | null): AsyncGenerator<...>
```

### Files Modified

- `src/ui/utils/api.ts` - Added ThreadIdChunk, updated AnswerRequest and
  answer()
- `src/ui/App.tsx` - Added threadId state, updated streamAnswer
- `tests/ui/api.spec.ts` - Updated tests for new API signature

---

## Thread API Correction (Original)

**Date:** 2026-01-19

### Summary

Corrected the thread implementation to use the Agent Framework's proper thread
API with `AgentThread` objects instead of simple string thread_id parameters.

### Changes Made

1. **QAEngine Thread Handling**
   - Use `agent.get_new_thread()` to create new threads
   - Use `agent.get_new_thread(service_thread_id=thread_id)` to continue
     existing
   - Pass `thread` parameter (not `thread_id`) to `run_stream()`
   - Enable `store=True` to persist threads server-side
   - Use lazy `_thread_id_getter` to capture `service_thread_id` after
     streaming

2. **InvokeStreamingResult Changes**
   - Added `_thread_id_getter` callable to lazy-load thread_id
   - `thread_id` property delegates to getter for deferred evaluation
   - Thread ID is available after streaming completes (set by framework)

3. **API Endpoint Adjustment**
   - Emit `thread_id` at END of stream (not beginning)
   - Thread ID only available after `run_stream` completes
   - Frontend handles thread_id regardless of position in stream

4. **Test Updates**
   - Created `create_mock_thread()` helper for consistent mocking
   - Mock `AgentThread` with `service_thread_id` property
   - Mock `agent.get_new_thread()` to return mock threads
   - Updated assertions to verify correct thread API usage

### Technical Details

The Agent Framework's thread API works as follows:
- `get_new_thread()` creates a new `AgentThread` object
- `get_new_thread(service_thread_id="...")` creates thread for existing
  conversation
- `run_stream(prompt, thread=thread, store=True)` sends message in thread
- `thread.service_thread_id` is populated AFTER streaming completes
- The framework internally calls
  `_update_thread_with_type_and_conversation_id()`

### Files Modified

- `src/core/qa_engine.py` - Proper AgentThread usage
- `src/api/generate.py` - Thread_id emitted at end of stream
- `tests/core/test_qa_engine.py` - Thread mock helpers and updated tests
- `tests/api/test_generate_endpoint.py` - Relaxed thread_id format check
