#!/usr/bin/env bash
#? Run tests for the backend or frontend
# Exit immediately if any command fails (-e) and if any command in a pipeline fails (-o pipefail)
set -eo pipefail
# Change to the project root directory (parent of the bin directory)
cd "$(dirname "$0")/.."

# Display usage information
usage() {  
    echo "Usage: $0 [-skipIT] [be | fe]"
    echo "  If no argument is provided, runs all tests (backend and frontend)"
    exit 1
}

# Parse command-line options
while :; do
    case $1 in
            -h|--help) usage; exit ;;
            --skipIT) skipIT=1 ;;  # Flag to skip integration tests
            *) break ;;    # Break loop when we hit the main argument (be|fe)
    esac    
    shift  # Move to the next argument
done

# Default to "all" if no argument provided
target="${1:-all}"
    
# Execute tests based on the provided argument
case "$target" in  
    be)  # Backend tests
        if [[ $skipIT ]]; then
            # Run pytest excluding integration tests (-m 'not integration')
            # Generate coverage report in XML format and display missing lines in terminal
            uv run pytest --cov=src/ --cov-report=xml:coverage.xml --cov-report=term-missing -m 'not integration'    
        else      
            # Run all pytest tests including integration tests
            # Generate coverage report in XML format and display missing lines in terminal
            uv run pytest --cov=src/ --cov-report=xml:coverage.xml --cov-report=term-missing    
        fi    
        ;;  

    fe)    
        npm run test    
        ;;

    all)  # Run all tests
        echo "Running backend tests..."
        if [[ $skipIT ]]; then
            uv run pytest --cov=src/ --cov-report=xml:coverage.xml --cov-report=term-missing -m 'not integration'    
        else      
            uv run pytest --cov=src/ --cov-report=xml:coverage.xml --cov-report=term-missing    
        fi
        echo ""
        echo "Running frontend tests..."
        npm run test
        ;;
    # 
    *)    
        echo "Error: Invalid argument '$target'."    
        usage    
        ;;
esac